(function(){const l=document.getElementById("blocks"),y=document.getElementById("btnExportMd"),E=document.getElementById("btnPrint"),b=document.getElementById("sessionLabel"),d=(function(){const e=window.location.pathname.split("/").filter(Boolean),t=e.indexOf("session");return t>=0&&e.length>t+1?e[t+1]:new URL(window.location.href).searchParams.get("id")||"dev"})();b.textContent=`Session: ${d}`;let a={images:[],notes:{}};async function S(){const n=await fetch(`/api/session/${d}`);if(!n.ok){l.innerHTML="<li>Session not found.</li>";return}const e=await n.json();a.images=e.images||[];try{if(e.doc){const t=JSON.parse(e.doc);if(a.notes=t.notes||{},Array.isArray(t.order)&&t.order.length){const o=new Set(a.images);a.images=t.order.filter(s=>o.has(s))}}}catch{}w()}function w(){l.innerHTML="",a.images.forEach((n,e)=>{const t=document.createElement("li");t.className="block",t.dataset.image=n;const o=document.createElement("div");o.className="note",o.contentEditable="true",o.placeholder="Write notes here\u2026",o.textContent=a.notes[n]||"",o.addEventListener("input",()=>{a.notes[n]=o.textContent,g()});const s=new Image;s.src=n,s.alt=`Capture ${e+1}`,t.appendChild(o),t.appendChild(s),l.appendChild(t)}),new Sortable(l,{animation:150,ghostClass:"drag-ghost",chosenClass:"drag-chosen",onSort:()=>{a.images=Array.from(l.querySelectorAll(".block")).map(n=>n.dataset.image),g()}})}let f=null;function g(){clearTimeout(f),f=setTimeout(A,400)}async function A(){const n={notes:a.notes,order:a.images};await fetch(`/api/session/${d}/doc`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})}async function k(){if(typeof JSZip>"u"||typeof saveAs>"u"){alert("ZIP export libraries not loaded. Include JSZip and FileSaver in index.html.");return}const n=new JSZip,e=[];e.push(`# SnapStep \u2014 ${d}`),e.push(""),e.push(`_Exported: ${new Date().toLocaleString()}_`),e.push("");const t=Array.from(document.querySelectorAll(".block"));let o=1;for(const p of t){const i=p.dataset.image,u=(a.notes[i]||"").trim(),r=p.querySelector("img");if(!r)continue;const c=await fetch(r.src,{cache:"no-store"});if(!c.ok)continue;const m=await c.blob(),x=m.type&&m.type.split("/")[1]||"png",h=`images/${String(o).padStart(4,"0")}.${x}`;n.file(h,m),u&&(e.push(u),e.push("")),e.push(`![capture ${o}](${h})`),e.push(""),o++}n.file("README.md",e.join(`
`));const s=await n.generateAsync({type:"blob"});saveAs(s,`snapstep_${d}.zip`)}y.addEventListener("click",()=>{k().catch(n=>{console.error("Export failed:",n),alert("Export failed. See console for details.")})}),E.addEventListener("click",()=>{const e=9.600000000000001,t=Array.from(document.querySelectorAll(".block"));t.forEach(s=>s.style.transform="");let o=0;for(const s of t){const i=s.getBoundingClientRect().height,r=1048-o%1048;if(i+e>r){const c=(r-e)/i;if(c>.85&&c<1){s.style.transform=`scale(${c})`,o+=i*c+e;continue}o+=r+i+e;continue}o+=i+e}window.print(),setTimeout(()=>t.forEach(s=>s.style.transform=""),500)}),S()})();
